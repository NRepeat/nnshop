# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

- **Dev server**: `npm run dev` (Next.js with Turbopack)
- **Build**: `npm run build` (runs `prisma generate` then Next.js build)
- **Lint**: `npm run lint` (ESLint flat config)
- **Format**: `npm run format` / `npm run format:check` (Prettier)
- **GraphQL codegen**: `npm run graphql-codegen` (generates Shopify Storefront API types to `src/shared/lib/shopify/types/` as `.d.ts` declaration files)
- **Sanity typegen**: `npm run typegen` (extracts Sanity schema + generates types to `src/shared/sanity/types.ts`)
- **DB migrations**: `npx prisma migrate dev` / `npx prisma studio`
- No test framework is configured.

## Architecture

### Stack

Next.js 16 (App Router, Turbopack, React 19) with:
- **Shopify Storefront API** (GraphQL) — products, collections, cart, orders, menus
- **Shopify Admin API** — order management, draft orders (OAuth tokens cached in DB)
- **Sanity v4** — CMS for content pages, blog, site settings, hero, redirects; Studio at `/studio`
- **PostgreSQL + Prisma v7** — app database (users, sessions, orders, favorites, Nova Poshta)
- **better-auth** — auth (email/password, Google OAuth, Shopify OAuth, anonymous sessions)
- **next-intl** — i18n with locales `uk` (default) and `ru`; messages in `messages/*.json`
- **Tailwind CSS v4** + **shadcn/ui** (new-york style) — styling
- **Zustand** — client state; **nuqs** — URL search params as state
- **LiqPay** — payment gateway; **Nova Poshta** — delivery service
- **Resend** — transactional emails; **eSputnik** — email marketing

### Feature-Sliced Design (FSD)

```
src/
  entities/      # Business entities (cart, product, collection, order, etc.)
  features/      # User-facing features (auth, cart, collection, product, checkout, etc.)
  shared/        # Shared code (ui, lib, hooks, i18n, sanity, store, types)
  widgets/       # Composite UI blocks (header, footer, checkout, product-view, etc.)
```

Each slice can have: `api/` (data fetching), `ui/` (components), `model/` (Zustand stores), `lib/` (utilities), `schema/` (Zod validation).

### Path Aliases

| Alias | Path |
|-------|------|
| `@entities/*` | `src/entities/*` |
| `@features/*` | `src/features/*` |
| `@widgets/*` | `src/widgets/*` |
| `@shared/*` | `src/shared/*` |
| `@/*` | `src/*` |
| `~/*` | `./*` |

### Routing

All frontend routes under `app/[locale]/(frontend)/`:
- Gender-segmented collections: `(home)/[gender]/(collection)/[slug]/`
- Products: `(product)/product/[slug]/`
- Intercepted routes: `@modal/(.)quick/[slug]/` (quick-view modal), `@auth/(.)auth/[authView]/` (auth modal)
- Parallel route: `@receipt/` in checkout for sidebar
- `proxy.ts` at root exports named `proxy` function + `config` matcher; handles i18n routing, root→`/uk/woman` redirect, and `/[locale]/productt/` typo correction (301)
- `next.config.ts` fetches redirects from Sanity at build time via `fetchRedirects()`; Prisma client generated to non-standard path `generated/prisma`

### Data Fetching Patterns

- **Server Components** fetch data directly — no client-side fetching for primary data
- Shopify: `storefrontClient.request<QueryType, VarsType>({ query, language, cache, tags })`
- Sanity: `sanityFetch({ query, params, revalidate, tags })` with GROQ queries from `src/shared/sanity/lib/query.ts`
- Server Actions marked `'use server'` at file top
- Experimental `'use cache'` + `cacheLife()` directives used for Dynamic IO caching
- Client components use `Client` suffix (e.g., `NavigationClient.tsx`, `ClientGrid.tsx`)

### Shopify Clients

`src/shared/lib/clients/` contains three clients extending `BaseShopifyClient`:
- **`StorefrontClient`** — singleton for Storefront API; uses `@inContext(language: ...)` for locale-aware queries, retry logic (3 retries, exponential backoff on 502/503), types generated by `@shopify/api-codegen-preset`
- **`AdminClient`** — Shopify Admin GraphQL API; uses `X-Shopify-Access-Token` header
- **`CustomerAccountClient`** — Shopify Customer Account API (`shopify.com/{shopId}/account/...`)
- **`ShopifyFactory`** — creates and manages Admin/Customer tokens with OAuth, caching tokens in the Prisma DB with refresh buffer logic

### Auth

better-auth with server config at `src/features/auth/lib/auth.ts`, client at `src/features/auth/lib/auth-client.ts`. UI via `@daveyplate/better-auth-ui`. Supports anonymous sessions that merge on sign-in.

### Forms

`react-hook-form` + `@hookform/resolvers` + `Zod v4`. Schemas co-located in `schema/` subdirectory per feature.
